<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Canvas Place</title>
        <style>
            body {
                margin: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                background-color: #f0f0f0;
                font-family: Arial, sans-serif;
            }
            #canvas {
                margin: 20px;
                border: 1px solid #ccc;
                cursor: crosshair;
                image-rendering: pixelated;
                width: 512px;
                height: 512px;
                position: relative;
            }
            #colorPicker {
                margin: 10px;
                padding: 10px;
                background-color: white;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            #status {
                margin: 10px;
                padding: 10px;
                border-radius: 5px;
                background-color: white;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            #cooldown {
                width: 200px;
                height: 10px;
                background: #ddd;
                border-radius: 5px;
                overflow: hidden;
                margin: 10px;
            }
            #cooldownBar {
                width: 0%;
                height: 100%;
                background: #4caf50;
            }
            .bot-overlay {
                position: absolute;
                pointer-events: none;
                z-index: 1000;
                transition: opacity 0.3s;
            }
            .bot-overlay:hover {
                opacity: 0.8;
            }
            #controls {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin: 10px;
                padding: 10px;
                background-color: white;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            #progress {
                width: 200px;
                height: 20px;
                background: #ddd;
                border-radius: 5px;
                overflow: hidden;
                margin: 10px;
            }
            #progressBar {
                width: 0%;
                height: 100%;
                background: #4caf50;
            }
        </style>
    </head>
    <body>
        <div id="colorPicker">
            Color: <input type="color" id="color" value="#000000" />
        </div>
        <canvas id="canvas" width="64" height="64"></canvas>
        <div id="status">Ready</div>
        <div id="cooldown"><div id="cooldownBar"></div></div>
        <div id="controls">
            <label>
                <input type="checkbox" id="botJobStatus" checked />
                Show Bot Job Status
            </label>
            <label>
                <input type="checkbox" id="wantedResultOverlay" checked />
                Show Wanted Result Overlay
            </label>
            <div id="progress"><div id="progressBar"></div></div>
        </div>
        <script>
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d", { willReadFrequently: true });
            const colorPicker = document.getElementById("color");
            const status = document.getElementById("status");
            const cooldownBar = document.getElementById("cooldownBar");
            const botJobStatusCheckbox =
                document.getElementById("botJobStatus");
            const wantedResultOverlayCheckbox = document.getElementById(
                "wantedResultOverlay",
            );
            const progressBar = document.getElementById("progressBar");

            let canPlace = true;
            let cooldownTimeout;
            let cooldownInterval;
            let animationStart;

            function hexToRgb(hex) {
                const r = parseInt(hex.substr(1, 2), 16);
                const g = parseInt(hex.substr(3, 2), 16);
                const b = parseInt(hex.substr(5, 2), 16);
                return { r, g, b };
            }

            function animate(timestamp) {
                if (!animationStart) animationStart = timestamp;
                const elapsed = timestamp - animationStart;
                const duration = cooldownBar.dataset.duration;

                if (elapsed < duration) {
                    const progress = elapsed / duration;
                    cooldownBar.style.width = `${progress * 100}%`;
                    requestAnimationFrame(animate);
                } else {
                    cooldownBar.style.width = "100%";
                }
            }

            async function updateBotOverlays() {
                if (!botJobStatusCheckbox.checked) return;

                try {
                    const response = await fetch(
                        "http://hackclub.app:38425/jobs",
                        {
                            method: "GET",
                            headers: {
                                Authorization: "Bearer test",
                                "Content-Type": "application/json",
                            },
                        },
                    );
                    const jobs = await response.json();

                    document
                        .querySelectorAll(".bot-overlay")
                        .forEach((o) => o.remove());

                    const colors = jobs.workingRegions.map((region) => {
                        const hue =
                            (parseInt(region.id) % jobs.botCount) *
                            (360 / jobs.botCount);
                        return `hsla(${hue}, 70%, 50%, 0.4)`;
                    });

                    const canvasRect = canvas.getBoundingClientRect();
                    const scale = canvasRect.width / 64;

                    jobs.workingRegions.forEach((region, index) => {
                        const overlay = document.createElement("div");
                        overlay.classList.add("bot-overlay");

                        overlay.style.left = `${region.startX * scale + canvasRect.left}px`;
                        overlay.style.top = `${region.startY * scale + canvasRect.top}px`;
                        overlay.style.width = `${region.regionSize * scale}px`;
                        overlay.style.height = `${region.regionSize * scale}px`;
                        overlay.style.backgroundColor = colors[index];
                        overlay.style.border = `2px solid ${colors[index].replace("0.2", "0.5")}`;

                        overlay.title = `Bot ${region.hardwareId}\nLast seen: ${new Date(region.lastSeen).toLocaleString()}`;

                        document.body.appendChild(overlay);
                    });
                } catch (error) {
                    console.error("Failed to update bot overlays:", error);
                }
            }

            async function updateCanvas() {
                try {
                    const response = await fetch(
                        "https://place.danieldb.uk/get_state",
                    );
                    const state = await response.json();

                    for (let y = 0; y < state.length; y++) {
                        for (let x = 0; x < state[y].length; x++) {
                            ctx.fillStyle = `rgb(${state[y][x][0]}, ${state[y][x][1]}, ${state[y][x][2]})`;
                            ctx.fillRect(x, y, 1, 1);
                        }
                    }
                    await updateBotOverlays();
                    await updateDesiredState();
                } catch (error) {
                    console.error("Failed to update canvas:", error);
                }
            }

            async function updateDesiredState() {
                if (!wantedResultOverlayCheckbox.checked) return;

                try {
                    const response = await fetch(
                        "http://hackclub.app:38425/desired",
                        {
                            method: "GET",
                            headers: {
                                Authorization: "Bearer test",
                                "Content-Type": "application/json",
                            },
                        },
                    );
                    const desiredState = await response.json();
                    let totalPixels = 0;
                    let correctPixels = 0;

                    for (let y = 0; y < desiredState.length; y++) {
                        for (let x = 0; x < desiredState[y].length; x++) {
                            const desiredPixel = desiredState[y][x];
                            const currentPixel = ctx.getImageData(
                                x,
                                y,
                                1,
                                1,
                            ).data;
                            totalPixels++;
                            if (
                                desiredPixel.r !== currentPixel[0] ||
                                desiredPixel.g !== currentPixel[1] ||
                                desiredPixel.b !== currentPixel[2]
                            ) {
                                ctx.fillStyle = `rgba(${desiredPixel.r}, ${desiredPixel.g}, ${desiredPixel.b}, 0.25)`;
                                ctx.fillRect(x, y, 1, 1);
                            } else {
                                correctPixels++;
                            }
                        }
                    }
                    const progress = (correctPixels / totalPixels) * 100;
                    progressBar.style.width = `${progress}%`;
                } catch (error) {
                    console.error("Failed to update desired state:", error);
                }
            }

            async function placePixel(x, y, color) {
                if (!canPlace) {
                    status.textContent = "Please wait for the cooldown";
                    return;
                }

                try {
                    const scaledX = Math.floor(x * (64 / canvas.offsetWidth));
                    const scaledY = Math.floor(y * (64 / canvas.offsetHeight));

                    const response = await fetch("/set_pixel_color", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            x: scaledX,
                            y: scaledY,
                            ...color,
                        }),
                    });

                    const data = await response.json();

                    if (response.status === 429) {
                        status.textContent = `Rate limited. Try again in ${data.try_in}s`;
                        canPlace = false;
                        clearTimeout(cooldownTimeout);

                        cooldownBar.style.width = "0%";
                        cooldownBar.dataset.duration = data.try_in * 1000;
                        animationStart = null;
                        requestAnimationFrame(animate);

                        cooldownTimeout = setTimeout(() => {
                            canPlace = true;
                            status.textContent = "Ready";
                            cooldownBar.style.width = "0%";
                        }, data.try_in * 1000);

                        await updateCanvas();
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(data.error || "Failed to place pixel");
                    }

                    ctx.fillStyle = `rgb(${color.r}, ${color.g}, ${color.b})`;
                    ctx.fillRect(scaledX, scaledY, 1, 1);
                } catch (error) {
                    status.textContent = `Error: ${error.message}`;
                    console.error("Failed to place pixel:", error);
                    await updateCanvas();
                }
            }

            canvas.addEventListener("click", (event) => {
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                const color = hexToRgb(colorPicker.value);
                placePixel(x, y, color);
            });

            setInterval(updateCanvas, 2000);

            updateCanvas();
        </script>
    </body>
</html>
